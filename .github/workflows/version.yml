name: Version & Release Packages

on:
  push:
    branches:
      - master
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20
          cache: "npm"

      - name: Install dependencies
        run: npm install

      - name: Generate Changesets automatically
        run: |
          # Find changed packages since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 || echo "")
          if [ -n "$LAST_TAG" ]; then
            CHANGED=$(git diff --name-only $LAST_TAG HEAD | grep -E '^(bot|web)/' | cut -d/ -f1 | sort -u)
          else
            CHANGED="bot web"
          fi

          for pkg in $CHANGED; do
            echo "Creating changeset for $pkg"
            npx changeset add --empty --summary "Auto bump $pkg due to changes"
          done

      - name: Create & Publish Releases
        uses: changesets/action@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Fire off Jenkins
        run: |
          curl -X POST https://jenkins.alphagame.dev/multibranch-webhook-trigger/invoke?token=${{secrets.JENKINS_BUILD_TOKEN}}
